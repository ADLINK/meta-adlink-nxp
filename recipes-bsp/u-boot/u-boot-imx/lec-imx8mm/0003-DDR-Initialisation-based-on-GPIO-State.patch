From 5974878a13b196568d7ec11c92b8de1d9dddce91 Mon Sep 17 00:00:00 2001
From: Dinesh V <dinesh.v@adlinktech.com>
Date: Mon, 28 Aug 2023 11:53:58 +0530
Subject: [PATCH 3/3] DDR Initialisation based on GPIO State

---
 arch/arm/mach-imx/imx8m/soc.c | 59 ++++++++++++++++++++++++++++++++---
 common/board_info.c           | 19 +++++++++++
 2 files changed, 74 insertions(+), 4 deletions(-)

diff --git a/arch/arm/mach-imx/imx8m/soc.c b/arch/arm/mach-imx/imx8m/soc.c
index 0d2f7a5897..86838f0c5f 100644
--- a/arch/arm/mach-imx/imx8m/soc.c
+++ b/arch/arm/mach-imx/imx8m/soc.c
@@ -43,6 +43,22 @@ struct imx_sec_config_fuse_t const imx_sec_config_fuse = {
 };
 #endif
 
+#define GPIO3_DR_ADDR	0x30220000
+#define SKU_CFG1	6
+#define SKU_CFG2	9
+
+int get_dram_sku(void)
+{
+	int dram_sku,dram_sku_cfg1,dram_sku_cfg2;
+	unsigned int dram_sku_data;
+
+	dram_sku_data = readl(GPIO3_DR_ADDR);
+	dram_sku_cfg1 = ((dram_sku_data >> SKU_CFG1) & (0x1));
+	dram_sku_cfg2 = ((dram_sku_data >> SKU_CFG2) & (0x1));
+	dram_sku=((dram_sku_cfg1 <<1)|(dram_sku_cfg2));
+	return dram_sku;
+}
+
 int timer_init(void)
 {
 #ifdef CONFIG_SPL_BUILD
@@ -188,9 +204,28 @@ static unsigned int imx8m_find_dram_entry_in_mem_map(void)
 {
 	int i;
 
-	for (i = 0; i < ARRAY_SIZE(imx8m_mem_map); i++)
-		if (imx8m_mem_map[i].phys == CONFIG_SYS_SDRAM_BASE)
-			return i;
+	for (i = 0; i < ARRAY_SIZE(imx8m_mem_map); i++){
+		if (imx8m_mem_map[i].phys == CONFIG_SYS_SDRAM_BASE) {
+			/* resetup dram size by sku */
+			switch (get_dram_sku()){
+				case 3:  //4GB
+					imx8m_mem_map[i].size = 0xC0000000;
+					imx8m_mem_map[i+1].size = 0x40000000;
+					break;
+				case 2:	//2GB
+					imx8m_mem_map[i].size = 0x80000000;
+					break;
+				case 1:	//1GB
+					imx8m_mem_map[i].size = 0x40000000;
+					break;
+				case 0:	//512M
+					imx8m_mem_map[i].size = 0x20000000;
+					break;
+			}
+ 			return i;
+		}
+	}
+ 
 
 	hang();	/* Entry not found, this must never happen. */
 }
@@ -230,11 +265,27 @@ __weak int board_phys_sdram_size(phys_size_t *size)
 {
 	if (!size)
 		return -EINVAL;
-
+#if 0
 	*size = PHYS_SDRAM_SIZE;
 
 #ifdef PHYS_SDRAM_2_SIZE
 	*size += PHYS_SDRAM_2_SIZE;
+#endif
+#else
+	switch (get_dram_sku()) {
+		case 3: //4GB
+			*size = 0x100000000;
+			break;
+		case 2:	//2GB
+			*size = 0x80000000;
+			break;
+		case 1: //1GB
+			*size = 0x40000000;
+			break;
+		case 0:	//512MB
+			*size = 0x20000000;
+			break;
+	}
 #endif
 	return 0;
 }
diff --git a/common/board_info.c b/common/board_info.c
index e0f2d93922..2ca4177c8b 100644
--- a/common/board_info.c
+++ b/common/board_info.c
@@ -29,6 +29,7 @@ int __weak show_board_info(void)
 		char str[80];
 		int ret = -ENOSYS;
 
+#if 0
 		if (IS_ENABLED(CONFIG_SYSINFO)) {
 			/* This might provide more detail */
 			ret = sysinfo_get(&dev);
@@ -47,6 +48,24 @@ int __weak show_board_info(void)
 			model = fdt_getprop(gd->fdt_blob, 0, "model", NULL);
 		else
 			model = str;
+#else
+	switch (get_dram_sku()){
+		case 3:	//4GB
+			model = "ADLINK lec-imx8mm LPDDR4 4GB SOM";
+			break;
+		case 2:	//2GB
+			model = "ADLINK lec-imx8mm LPDDR4 2GB SOM";
+			break;
+		case 1:	//1GB
+			model = "ADLINK lec-imx8mm LPDDR4 1GB SOM";
+			break;
+		case 0: //512MB
+			model = "ADLINK lec-imx8mm LPDDR4 512MB SOM";
+			break;
+		default:
+			model = "Can not got dram sku";
+	}
+#endif
 
 		if (model)
 			printf("Model: %s\n", model);
-- 
2.25.1

