From b63901badcf5e39bd1736bd8b00257d914d2c255 Mon Sep 17 00:00:00 2001
From: "deepak.s" <deepak.s@adlinktech.com>
Date: Mon, 11 Mar 2024 18:40:35 +0530
Subject: [PATCH] DDR-Initialisation-based-on-GPIO-State

---
 arch/arm/mach-imx/imx8m/soc.c | 59 ++++++++++++++++++++++++++++++++---
 common/board_info.c           | 20 +++++++++++-
 2 files changed, 74 insertions(+), 5 deletions(-)

diff --git a/arch/arm/mach-imx/imx8m/soc.c b/arch/arm/mach-imx/imx8m/soc.c
index 88e66d2709..18ca89a293 100644
--- a/arch/arm/mach-imx/imx8m/soc.c
+++ b/arch/arm/mach-imx/imx8m/soc.c
@@ -48,6 +48,23 @@ struct imx_sec_config_fuse_t const imx_sec_config_fuse = {
 };
 #endif
 
+#define GPIO3_DR_ADDR  0x30220000
+#define SKU_CFG1       6
+#define SKU_CFG2       9
+
+int get_dram_sku(void)
+{
+       int dram_sku,dram_sku_cfg1,dram_sku_cfg2;
+       unsigned int dram_sku_data;
+
+       dram_sku_data = readl(GPIO3_DR_ADDR);
+       dram_sku_cfg1 = ((dram_sku_data >> SKU_CFG1) & (0x1));
+       dram_sku_cfg2 = ((dram_sku_data >> SKU_CFG2) & (0x1));
+       dram_sku=((dram_sku_cfg1 <<1)|(dram_sku_cfg2));
+       return dram_sku;
+}
+
+
 int timer_init(void)
 {
 #ifdef CONFIG_SPL_BUILD
@@ -199,9 +216,27 @@ static unsigned int imx8m_find_dram_entry_in_mem_map(void)
 {
 	int i;
 
-	for (i = 0; i < ARRAY_SIZE(imx8m_mem_map); i++)
-		if (imx8m_mem_map[i].phys == CFG_SYS_SDRAM_BASE)
-			return i;
+       for (i = 0; i < ARRAY_SIZE(imx8m_mem_map); i++){
+               if (imx8m_mem_map[i].phys == CONFIG_SYS_SDRAM_BASE) {
+                       /* resetup dram size by sku */
+                       switch (get_dram_sku()){
+                               case 3:  //4GB
+                                       imx8m_mem_map[i].size = 0xC0000000;
+                                       imx8m_mem_map[i+1].size = 0x40000000;
+                                       break;
+                               case 2: //2GB
+                                       imx8m_mem_map[i].size = 0x80000000;
+                                       break;
+                               case 1: //1GB
+                                       imx8m_mem_map[i].size = 0x40000000;
+                                       break;
+                               case 0: //512M
+                                       imx8m_mem_map[i].size = 0x20000000;
+                                       break;
+                       }
+                       return i;
+               }
+       }
 
 	hang();	/* Entry not found, this must never happen. */
 }
@@ -241,11 +276,27 @@ __weak int board_phys_sdram_size(phys_size_t *size)
 {
 	if (!size)
 		return -EINVAL;
-
+#if 0
 	*size = PHYS_SDRAM_SIZE;
 
 #ifdef PHYS_SDRAM_2_SIZE
 	*size += PHYS_SDRAM_2_SIZE;
+#endif
+#else
+       switch (get_dram_sku()) {
+               case 3: //4GB
+                       *size = 0x100000000;
+                       break;
+               case 2: //2GB
+                       *size = 0x80000000;
+                       break;
+               case 1: //1GB
+                       *size = 0x40000000;
+                       break;
+               case 0: //512MB
+                       *size = 0x20000000;
+                       break;
+       }
 #endif
 	return 0;
 }
diff --git a/common/board_info.c b/common/board_info.c
index e0f2d93922..3f8ea68284 100644
--- a/common/board_info.c
+++ b/common/board_info.c
@@ -28,7 +28,7 @@ int __weak show_board_info(void)
 		const char *model;
 		char str[80];
 		int ret = -ENOSYS;
-
+#if 0
 		if (IS_ENABLED(CONFIG_SYSINFO)) {
 			/* This might provide more detail */
 			ret = sysinfo_get(&dev);
@@ -47,6 +47,24 @@ int __weak show_board_info(void)
 			model = fdt_getprop(gd->fdt_blob, 0, "model", NULL);
 		else
 			model = str;
+#else
+       switch (get_dram_sku()){
+               case 3: //4GB
+                       model = "ADLINK lec-imx8mm LPDDR4 4GB SOM";
+                       break;
+               case 2: //2GB
+                       model = "ADLINK lec-imx8mm LPDDR4 2GB SOM";
+                       break;
+               case 1: //1GB
+                       model = "ADLINK lec-imx8mm LPDDR4 1GB SOM";
+                       break;
+               case 0: //512MB
+                       model = "ADLINK lec-imx8mm LPDDR4 512MB SOM";
+                       break;
+               default:
+                       model = "Can not got dram sku";
+       }
+#endif
 
 		if (model)
 			printf("Model: %s\n", model);
-- 
2.43.2

