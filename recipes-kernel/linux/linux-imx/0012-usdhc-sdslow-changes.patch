From f9342280d25428187358ba9061f1cb1e54a3b175 Mon Sep 17 00:00:00 2001
From: Antony <antonyabee.prakashxv@adlinktech.com>
Date: Mon, 8 Jul 2019 11:50:10 +0530
Subject: [PATCH 2/2] usdhc-sdslow-changes

---
 arch/arm64/boot/dts/adlink/adlink-lec-imx8m.dts | 79 ++++++++++++++-----------
 1 file changed, 45 insertions(+), 34 deletions(-)

diff --git a/arch/arm64/boot/dts/adlink/adlink-lec-imx8m.dts b/arch/arm64/boot/dts/adlink/adlink-lec-imx8m.dts
index 6063edf..c80c49a 100644
--- a/arch/arm64/boot/dts/adlink/adlink-lec-imx8m.dts
+++ b/arch/arm64/boot/dts/adlink/adlink-lec-imx8m.dts
@@ -17,6 +17,7 @@
 
 #include "fsl-imx8mq.dtsi"
 #include <dt-bindings/net/ti-dp83867.h>
+#define sdslow 1
 
 / {
 	model = "Adlink LEC iMX8M";
@@ -235,34 +236,34 @@
 
 		pinctrl_usdhc1_100mhz: usdhc1grp100mhz {
 			fsl,pins = <
-				MX8MQ_IOMUXC_SD1_CLK_USDHC1_CLK			0x8d
-				MX8MQ_IOMUXC_SD1_CMD_USDHC1_CMD			0xcd
-				MX8MQ_IOMUXC_SD1_DATA0_USDHC1_DATA0		0xcd
-				MX8MQ_IOMUXC_SD1_DATA1_USDHC1_DATA1		0xcd
-				MX8MQ_IOMUXC_SD1_DATA2_USDHC1_DATA2		0xcd
-				MX8MQ_IOMUXC_SD1_DATA3_USDHC1_DATA3		0xcd
-				MX8MQ_IOMUXC_SD1_DATA4_USDHC1_DATA4		0xcd
-				MX8MQ_IOMUXC_SD1_DATA5_USDHC1_DATA5		0xcd
-				MX8MQ_IOMUXC_SD1_DATA6_USDHC1_DATA6		0xcd
-				MX8MQ_IOMUXC_SD1_DATA7_USDHC1_DATA7		0xcd
-				MX8MQ_IOMUXC_SD1_STROBE_USDHC1_STROBE		0x8d
+				MX8MQ_IOMUXC_SD1_CLK_USDHC1_CLK			0x85
+				MX8MQ_IOMUXC_SD1_CMD_USDHC1_CMD			0xc5
+				MX8MQ_IOMUXC_SD1_DATA0_USDHC1_DATA0		0xc5
+				MX8MQ_IOMUXC_SD1_DATA1_USDHC1_DATA1		0xc5
+				MX8MQ_IOMUXC_SD1_DATA2_USDHC1_DATA2		0xc5
+				MX8MQ_IOMUXC_SD1_DATA3_USDHC1_DATA3		0xc5
+				MX8MQ_IOMUXC_SD1_DATA4_USDHC1_DATA4		0xc5
+				MX8MQ_IOMUXC_SD1_DATA5_USDHC1_DATA5		0xc5
+				MX8MQ_IOMUXC_SD1_DATA6_USDHC1_DATA6		0xc5
+				MX8MQ_IOMUXC_SD1_DATA7_USDHC1_DATA7		0xc5
+				MX8MQ_IOMUXC_SD1_STROBE_USDHC1_STROBE		0x85
 				MX8MQ_IOMUXC_SD1_RESET_B_USDHC1_RESET_B		0xc1
 			>;
 		};
 
 		pinctrl_usdhc1_200mhz: usdhc1grp200mhz {
 			fsl,pins = <
-				MX8MQ_IOMUXC_SD1_CLK_USDHC1_CLK			0x9f
-				MX8MQ_IOMUXC_SD1_CMD_USDHC1_CMD			0xdf
-				MX8MQ_IOMUXC_SD1_DATA0_USDHC1_DATA0		0xdf
-				MX8MQ_IOMUXC_SD1_DATA1_USDHC1_DATA1		0xdf
-				MX8MQ_IOMUXC_SD1_DATA2_USDHC1_DATA2		0xdf
-				MX8MQ_IOMUXC_SD1_DATA3_USDHC1_DATA3		0xdf
-				MX8MQ_IOMUXC_SD1_DATA4_USDHC1_DATA4		0xdf
-				MX8MQ_IOMUXC_SD1_DATA5_USDHC1_DATA5		0xdf
-				MX8MQ_IOMUXC_SD1_DATA6_USDHC1_DATA6		0xdf
-				MX8MQ_IOMUXC_SD1_DATA7_USDHC1_DATA7		0xdf
-				MX8MQ_IOMUXC_SD1_STROBE_USDHC1_STROBE		0x9f
+				MX8MQ_IOMUXC_SD1_CLK_USDHC1_CLK			0x87
+				MX8MQ_IOMUXC_SD1_CMD_USDHC1_CMD			0xc7
+				MX8MQ_IOMUXC_SD1_DATA0_USDHC1_DATA0		0xc7
+				MX8MQ_IOMUXC_SD1_DATA1_USDHC1_DATA1		0xc7
+				MX8MQ_IOMUXC_SD1_DATA2_USDHC1_DATA2		0xc7
+				MX8MQ_IOMUXC_SD1_DATA3_USDHC1_DATA3		0xc7
+				MX8MQ_IOMUXC_SD1_DATA4_USDHC1_DATA4		0xc7
+				MX8MQ_IOMUXC_SD1_DATA5_USDHC1_DATA5		0xc7
+				MX8MQ_IOMUXC_SD1_DATA6_USDHC1_DATA6		0xc7
+				MX8MQ_IOMUXC_SD1_DATA7_USDHC1_DATA7		0xc7
+				MX8MQ_IOMUXC_SD1_STROBE_USDHC1_STROBE		0x87
 				MX8MQ_IOMUXC_SD1_RESET_B_USDHC1_RESET_B		0xc1
 			>;
 		};
@@ -270,6 +271,9 @@
 		pinctrl_usdhc2_gpio: usdhc2grpgpio {
 			fsl,pins = <
 				MX8MQ_IOMUXC_SD2_CD_B_GPIO2_IO12	0x41
+                                MX8MQ_IOMUXC_GPIO1_IO12_GPIO1_IO12      0x41
+                                MX8MQ_IOMUXC_SD2_WP_GPIO2_IO20          0x41
+                                // SD2_RESET function is SOC SD dedicate, SMARC didn't really connect this GPIO
 				MX8MQ_IOMUXC_SD2_RESET_B_GPIO2_IO19	0x41
 			>;
 		};
@@ -288,24 +292,24 @@
 
 		pinctrl_usdhc2_100mhz: usdhc2grp100mhz {
 			fsl,pins = <
-				MX8MQ_IOMUXC_SD2_CLK_USDHC2_CLK			0x8d
-				MX8MQ_IOMUXC_SD2_CMD_USDHC2_CMD			0xcd
-				MX8MQ_IOMUXC_SD2_DATA0_USDHC2_DATA0		0xcd
-				MX8MQ_IOMUXC_SD2_DATA1_USDHC2_DATA1		0xcd
-				MX8MQ_IOMUXC_SD2_DATA2_USDHC2_DATA2		0xcd
-				MX8MQ_IOMUXC_SD2_DATA3_USDHC2_DATA3		0xcd
+				MX8MQ_IOMUXC_SD2_CLK_USDHC2_CLK			0x85
+				MX8MQ_IOMUXC_SD2_CMD_USDHC2_CMD			0xc5
+				MX8MQ_IOMUXC_SD2_DATA0_USDHC2_DATA0		0xc5
+				MX8MQ_IOMUXC_SD2_DATA1_USDHC2_DATA1		0xc5
+				MX8MQ_IOMUXC_SD2_DATA2_USDHC2_DATA2		0xc5
+				MX8MQ_IOMUXC_SD2_DATA3_USDHC2_DATA3		0xc5
 				MX8MQ_IOMUXC_GPIO1_IO04_USDHC2_VSELECT		0xc1
 			>;
 		};
 
 		pinctrl_usdhc2_200mhz: usdhc2grp200mhz {
 			fsl,pins = <
-				MX8MQ_IOMUXC_SD2_CLK_USDHC2_CLK			0x9f
-				MX8MQ_IOMUXC_SD2_CMD_USDHC2_CMD			0xdf
-				MX8MQ_IOMUXC_SD2_DATA0_USDHC2_DATA0		0xdf
-				MX8MQ_IOMUXC_SD2_DATA1_USDHC2_DATA1		0xdf
-				MX8MQ_IOMUXC_SD2_DATA2_USDHC2_DATA2		0xdf
-				MX8MQ_IOMUXC_SD2_DATA3_USDHC2_DATA3		0xdf
+				MX8MQ_IOMUXC_SD2_CLK_USDHC2_CLK			0x87
+				MX8MQ_IOMUXC_SD2_CMD_USDHC2_CMD			0xc7
+				MX8MQ_IOMUXC_SD2_DATA0_USDHC2_DATA0		0xc7
+				MX8MQ_IOMUXC_SD2_DATA1_USDHC2_DATA1		0xc7
+				MX8MQ_IOMUXC_SD2_DATA2_USDHC2_DATA2		0xc7
+				MX8MQ_IOMUXC_SD2_DATA3_USDHC2_DATA3		0xc7
 				MX8MQ_IOMUXC_GPIO1_IO04_USDHC2_VSELECT		0xc1
 			>;
 		};
@@ -628,12 +632,19 @@
 };
 
 &usdhc2 {
+
+#if sdslow
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_gpio>;
+#else
 	pinctrl-names = "default", "state_100mhz", "state_200mhz";
 	pinctrl-0 = <&pinctrl_usdhc2>, <&pinctrl_usdhc2_gpio>;
 	pinctrl-1 = <&pinctrl_usdhc2_100mhz>, <&pinctrl_usdhc2_gpio>;
 	pinctrl-2 = <&pinctrl_usdhc2_200mhz>, <&pinctrl_usdhc2_gpio>;
+#endif
 	bus-width = <4>;
 	cd-gpios = <&gpio2 12 GPIO_ACTIVE_LOW>;
+        wp-gpios = <&gpio2 20 GPIO_ACTIVE_HIGH>;
 	vmmc-supply = <&reg_usdhc2_vmmc>;
 	status = "okay";
 };
-- 
2.7.4

