From 34a804b634a6e01c3ab46d8d21a92cd983bd8604 Mon Sep 17 00:00:00 2001
From: "po.cheng" <po.cheng@adlinktech.com>
Date: Wed, 18 Oct 2023 09:35:12 +0800
Subject: [PATCH 03/16] sp2-imx8mp: patch: pcie_phy: modify nxp pcie phy to
 tune signal strength for adlink

Signed-off-by: po.cheng <po.cheng@adlinktech.com>
---
 drivers/phy/freescale/phy-fsl-imx8-pcie.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/drivers/phy/freescale/phy-fsl-imx8-pcie.c b/drivers/phy/freescale/phy-fsl-imx8-pcie.c
index 00fb8a7f0246..86bba635562f 100644
--- a/drivers/phy/freescale/phy-fsl-imx8-pcie.c
+++ b/drivers/phy/freescale/phy-fsl-imx8-pcie.c
@@ -142,7 +142,7 @@ static int imx8_pcie_phy_cal(struct phy *phy)
 	 * Fine tune the parameters of the PHY, let PCIe link up to GEN3
 	 * between two EVK boards in the EP/RC validation system.
 	 */
-	if (imx8_pcie_phy_tuned) {
+	if (imx8_pcie_phy_tuned == 1) {
 		writel(LN0_OVRD_TX_DRV_LVL_G1,
 		       imx8_phy->base + IMX8MP_PCIE_PHY_TRSV_REG001);
 		writel(LN0_OVRD_TX_DRV_LVL_G2,
@@ -177,6 +177,9 @@ static int imx8_pcie_phy_cal(struct phy *phy)
 		       imx8_phy->base + IMX8MP_PCIE_PHY_TRSV_REG159);
 		writel(LN0_TG_RX_SIGVAL_LBF_DELAY,
 		       imx8_phy->base + IMX8MP_PCIE_PHY_TRSV_REG206);
+	} else if (imx8_pcie_phy_tuned == 2) {
+		writel(0x25,
+		       imx8_phy->base + IMX8MP_PCIE_PHY_TRSV_REG001);
 	}
 
 	writel(PLL_ANA_LPF_R_SEL_FINE_0_4,
@@ -219,6 +222,10 @@ static int __init imx8_pcie_phy_fine_tune(char *str)
 		pr_info("i.MX PCIe PHY is fine tuned in EP/RC SYS.\n");
 		imx8_pcie_phy_tuned = 1;
 	}
+	if (!strcmp(str, "adlink")) {
+		pr_info("i.MX PCIe PHY is fine tuned by ADLINK.\n");
+		imx8_pcie_phy_tuned = 2;
+	}
 	return 1;
 }
 
-- 
2.25.1

