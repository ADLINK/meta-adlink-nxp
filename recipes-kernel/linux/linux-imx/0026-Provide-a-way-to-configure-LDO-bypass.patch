From 280ca1e6496aadd7437b2ad4996ed111c5699094 Mon Sep 17 00:00:00 2001
From: Dinesh kumar <dineshkumar.varadarajan@adlinktech.com>
Date: Fri, 5 Apr 2019 17:28:13 +0530
Subject: [PATCH 26/47] Provide a way to configure LDO bypass.

Statement from our FAE: "It's sensible to use the internal LDOs because of
their filtering effect on the voltages. It's also possible to bypass the
LDOs, this will save some power. However it isn't recommended unless power
consumption has absolute priority."

On the other hand Freescale's reference boards do enable LDO bypass per
default. But this requires continuous I2C communication with the PMIC; if
I2C2 is broken booting Linux will hang when initializing the "Galcore" GPU
driver.

The problems old LEC-iMX6 A1 revisions had are long solved, however bugs on
(custom) SMARC carriers might block I2C2, so it's still useful to be able to
disable LDO bypass. Freescale provides a seperate DTS, this patch introduces
a commented #define instead.

Note that if talking to the PMIC isn't possible it might also be necessary
to comment out vin-supply of reg_smarc_usb1.

Signed-off-by: Dinesh kumar <dineshkumar.varadarajan@adlinktech.com>
---
 arch/arm/boot/dts/lec-imx6.dtsi | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/lec-imx6.dtsi b/arch/arm/boot/dts/lec-imx6.dtsi
index 92789f3..2262d52 100644
--- a/arch/arm/boot/dts/lec-imx6.dtsi
+++ b/arch/arm/boot/dts/lec-imx6.dtsi
@@ -20,6 +20,17 @@
 #define CONFIG_SER_CAMERA	3c /* I2C addr of serial camera, hex without "0x" */
 //#define CONFIG_PAR_CAMERA	3c /* I2C addr of parallel camera */
 
+/* The on-module Freescale PF0100 PMIC provides VDD_ARM_IN, VDD_SOC_IN to the
+ * on-SoC Anatop LDOs, which then generate VDD_ARM (CPU cores), VDD_PU
+ * (GPU/VPU), VDD_SOC (the rest). To save power clock and voltage need to vary
+ * according to the workload.
+ * Normal: PMIC provides fixed voltage, internal LDO lowers voltage further to
+ *         required value, depending on clock frequency.
+ * LDO bypass: PMIC (switched!) provides variable voltage directly, controlled
+ *             via I2C; internal LDOs bridged (FETs permanently on).
+ * Bypassing saves power, but requires steady communication on i2c2 to work. */
+#define LDO_BYPASS	1
+
 /* Freescale defines 2 alternative DT nodes for the VPU: The one normally active
  * loads a driver called 'mxc_vpu'. The other, disabled one, would invoke a
  * different driver named 'coda'. I don't know what state it is in; none of
@@ -360,6 +371,15 @@
 };
 #endif
 
+&cpu0 {
+#if LDO_BYPASS
+ 	arm-supply = <&sw1a_reg>;
+	soc-supply = <&sw1c_reg>;
+#else
+	arm-supply = <&reg_arm>;
+	soc-supply = <&reg_soc>;
+#endif
+};
 
 &clks {
 	assigned-clocks = <&clks IMX6QDL_CLK_LDB_DI0_SEL>,  /*LVDS*/
@@ -395,7 +415,7 @@
 };
 
 &gpc {
-	fsl,ldo-bypass = <1>;
+	fsl,ldo-bypass = <LDO_BYPASS>; /* U-Boot will check it and configure */
 };
 
 &dcic1 {
-- 
2.7.4

