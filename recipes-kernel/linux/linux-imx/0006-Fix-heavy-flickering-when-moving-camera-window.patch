From 9e79e817fdee1da1c96d9cece50084d0599ff169 Mon Sep 17 00:00:00 2001
From: Santhana Kumar <santhanakumar.a@ltts.com>
Date: Thu, 4 Apr 2019 15:18:32 +0530
Subject: [PATCH 06/47] Fix heavy flickering when moving camera window.

This is done by adding a shortcut code path to the driver: if already
initialized and the overlay window's size is unchanged then just adjust the
position. Otherwise the full setup is done as before.

Signed-off-by: Santhana Kumar <santhanakumar.a@ltts.com>
---
 .../platform/mxc/capture/ipu_fg_overlay_sdc.c      | 23 +++++++++++++++-------
 1 file changed, 16 insertions(+), 7 deletions(-)

diff --git a/drivers/media/platform/mxc/capture/ipu_fg_overlay_sdc.c b/drivers/media/platform/mxc/capture/ipu_fg_overlay_sdc.c
index 4d6b136..a976c2a 100644
--- a/drivers/media/platform/mxc/capture/ipu_fg_overlay_sdc.c
+++ b/drivers/media/platform/mxc/capture/ipu_fg_overlay_sdc.c
@@ -358,11 +358,6 @@ static int foreground_start(void *private)
 		return -EIO;
 	}
 
-	if (cam->overlay_active == true) {
-		pr_debug("already started.\n");
-		return 0;
-	}
-
 	get_disp_ipu(cam);
 
 	for (i = 0; i < num_registered_fb; i++) {
@@ -379,10 +374,20 @@ static int foreground_start(void *private)
 		return -EPERM;
 	}
 
+	/* Shortcut, eliminates heavy flickering when someone simply moves the
+	 * window. If resizing we still do the full setup. */
+	if (cam->overlay_active && fbi->var.xres == cam->win.w.width
+	    && fbi->var.yres == cam->win.w.height) {
+		ipu_disp_set_window_pos(disp_ipu, MEM_FG_SYNC, cam->win.w.left,
+		                        cam->win.w.top);
+		return 0;
+	}
+
 	fbvar = fbi->var;
 
 	/* Store the overlay frame buffer's original std */
-	cam->fb_origin_std = fbvar.nonstd;
+	if (!cam->overlay_active)
+		cam->fb_origin_std = fbvar.nonstd;
 
 	if (cam->devtype == IMX5_V4L2 || cam->devtype == IMX6_V4L2) {
 		/* Use DP to do CSC so that we can get better performance */
@@ -430,6 +435,11 @@ static int foreground_start(void *private)
 	ipu_update_channel_buffer(disp_ipu, MEM_FG_SYNC, IPU_INPUT_BUFFER,
 					1, fbi->fix.smem_start);
 
+	if (cam->overlay_active) {
+		pr_debug("already started.\n");
+		return 0;
+	}
+
 	err = csi_enc_enabling_tasks(cam);
 	if (err != 0) {
 		printk(KERN_ERR "Error csi enc enable fail\n");
@@ -581,7 +591,6 @@ int foreground_sdc_select(void *private)
 		cam->vf_stop_sdc = foreground_stop;
 		cam->vf_enable_csi = foreground_enable_csi;
 		cam->vf_disable_csi = foreground_disable_csi;
-		cam->overlay_active = false;
 	} else
 		err = -EIO;
 
-- 
2.7.4

