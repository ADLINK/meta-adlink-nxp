From a711db3da58a25bc6dabaae37b523d4d543fb340 Mon Sep 17 00:00:00 2001
From: "po.cheng" <po.cheng@adlinktech.com>
Date: Fri, 1 Dec 2023 11:27:52 +0800
Subject: [PATCH 14/16] sp2-imx8mp: patch: pwm-bl and panel-lvds: move power
 off at pwm-bl to panel-lvds for timing, due to hardware design limitation on
 sp2imx8mp

Signed-off-by: po.cheng <po.cheng@adlinktech.com>
---
 drivers/gpu/drm/panel/panel-lvds.c | 20 ++++++++++++--------
 drivers/video/backlight/pwm_bl.c   |  8 +++++++-
 include/linux/pwm_backlight.h      |  1 +
 3 files changed, 20 insertions(+), 9 deletions(-)

diff --git a/drivers/gpu/drm/panel/panel-lvds.c b/drivers/gpu/drm/panel/panel-lvds.c
index aa3c1daaabd0..dbba269deea3 100644
--- a/drivers/gpu/drm/panel/panel-lvds.c
+++ b/drivers/gpu/drm/panel/panel-lvds.c
@@ -41,6 +41,7 @@ struct panel_lvds {
 
 	enum drm_panel_orientation orientation;
 
+	bool skip_blpwr_off;
 	unsigned int enable_delay;
 	unsigned int post_prepare_delay;
 	unsigned int pre_disable_delay;
@@ -80,13 +81,16 @@ static int panel_lvds_prepare(struct drm_panel *panel)
 	struct panel_lvds *lvds = to_panel_lvds(panel);
 
 	if (lvds->supply) {
-		int err;
-
-		err = regulator_enable(lvds->supply);
-		if (err < 0) {
-			dev_err(lvds->dev, "failed to enable supply: %d\n",
-				err);
-			return err;
+		/* if skip_blpwr_off is set, then don't enable supply. Leave it for blpwm to enable.
+		   NOTE: supply regulator must be the same regulator as the blpwm power-supply */
+		if (!lvds->skip_blpwr_off) {
+			int err;
+			err = regulator_enable(lvds->supply);
+			if (err < 0) {
+				dev_err(lvds->dev, "failed to enable supply: %d\n",
+					err);
+				return err;
+			}
 		}
 	}
 
@@ -211,7 +215,7 @@ static int panel_lvds_parse_dt(struct panel_lvds *lvds)
 	lvds->post_unprepare_delay = 0;
 	of_property_read_u32(np, "post-unprepare-delay-ms",
 			     &lvds->post_unprepare_delay);
-
+	lvds->skip_blpwr_off = of_property_read_bool(np, "skip-blpwr-off");
 
 	return 0;
 }
diff --git a/drivers/video/backlight/pwm_bl.c b/drivers/video/backlight/pwm_bl.c
index e0cc4d79b72b..4c564ba3b622 100644
--- a/drivers/video/backlight/pwm_bl.c
+++ b/drivers/video/backlight/pwm_bl.c
@@ -34,6 +34,7 @@ struct pwm_bl_data {
 	unsigned int		post_pwm_on_delay;
 	unsigned int		pwm_off_delay;
 	unsigned int		post_pwm_off_delay;
+	bool			skip_blpwr_off;
 	int			(*notify)(struct device *,
 					  int brightness);
 	void			(*notify_after)(struct device *,
@@ -92,7 +93,10 @@ static void pwm_backlight_power_off(struct pwm_bl_data *pb)
 	state.duty_cycle = 0;
 	pwm_apply_state(pb->pwm, &state);
 
-	regulator_disable(pb->power_supply);
+	/* if skip_blpwr_off is set, then don't disable supply. Leave it for lvds-panel to disable.
+		   NOTE: this supply regulator must be set to the lvds0-panel */
+	if (!pb->skip_blpwr_off)
+		regulator_disable(pb->power_supply);
 	pb->enabled = false;
 
 	if (pb->post_pwm_off_delay)
@@ -286,6 +290,7 @@ static int pwm_backlight_parse_dt(struct device *dev,
 	of_property_read_u32(node, "pwm-off-delay-ms", &data->pwm_off_delay);
 	of_property_read_u32(node, "post-pwm-off-delay-ms",
 			     &data->post_pwm_off_delay);
+	data->skip_blpwr_off = of_property_read_bool(node, "skip-blpwr-off");
 
 	/*
 	 * Determine the number of brightness levels, if this property is not
@@ -530,6 +535,7 @@ static int pwm_backlight_probe(struct platform_device *pdev)
 	pb->post_pwm_on_delay = data->post_pwm_on_delay;
 	pb->pwm_off_delay = data->pwm_off_delay;
 	pb->post_pwm_off_delay = data->post_pwm_off_delay;
+	pb->skip_blpwr_off = data->skip_blpwr_off;
 	strcpy(pb->fb_id, data->fb_id);
 
 	pb->enable_gpio = devm_gpiod_get_optional(&pdev->dev, "enable",
diff --git a/include/linux/pwm_backlight.h b/include/linux/pwm_backlight.h
index 05c315693d4e..c72461cbe2be 100644
--- a/include/linux/pwm_backlight.h
+++ b/include/linux/pwm_backlight.h
@@ -19,6 +19,7 @@ struct platform_pwm_backlight_data {
 	unsigned int post_pwm_on_delay;
 	unsigned int pwm_off_delay;
 	unsigned int post_pwm_off_delay;
+	bool skip_blpwr_off;
 	int (*init)(struct device *dev);
 	int (*notify)(struct device *dev, int brightness);
 	void (*notify_after)(struct device *dev, int brightness);
-- 
2.25.1

